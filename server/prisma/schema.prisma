generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentType {
  PERCH_FEE
  ENTRY_FEE
  HOTSPOT_FEE_1
  HOTSPOT_FEE_2
  HOTSPOT_FEE_3
  FINAL_RACE_FEE
  OTHER
}

enum Role {
  BREEDER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PROSPECT
}

enum EventType {
  AGN
  AS
}

enum EventStatus {
  OPEN
  CLOSED
}

enum RACETYPE {
  TRAINING
  INVENTORY
  LOFT_FLY
  PULLING_FLIGHT
  FINAL_RACE
  HOTSPOT_1
  HOTSPOT_2
  HOTSPOT_3
  AVG_WINNER
}

model User {
  id               String     @id @default(uuid())
  email            String     @unique
  name             String?
  role             Role       @default(BREEDER)
  password         String
  country          String?
  ssn              String?
  taxNumber        String?
  address          String?
  city             String?
  state            String?
  zip              String?
  primaryPhone     String?
  cellPhone        String?
  fax              String?
  sms              String?
  alternativeEmail String?
  webAddress       String?
  status           UserStatus @default(ACTIVE)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  payments Payment[]

  breederEvents EventInventory[]
  birds         Bird[]

  feeSchemasCreated   FeeSchema[]
  prizeSchemasCreated PrizeSchema[]
  events              Event[]
}

model FeeSchema {
  id                 String  @id @default(uuid())
  name               String
  entryFee           Float
  perchFee           Float
  expensePercentage  Float
  minEntryFee        Int
  entryFeeRefundable Boolean @default(false)
  hs1Fee             Float
  hs2Fee             Float
  hs3Fee             Float
  finalRaceFee       Float
  maxBirds           Int
  maxBackupBirds     Int
  floatingBackup     Boolean @default(false)
  Event              Event[]

  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdById String
}

model PrizeSchema {
  id              String              @id @default(uuid())
  name            String
  distributions   PrizeDistribution[]
  finalRaceEvents Event[]             @relation("FinalRacePrize")
  hotspot1Events  Event[]             @relation("Hotspot1Prize")
  hotspot2Events  Event[]             @relation("Hotspot2Prize")
  hotspot3Events  Event[]             @relation("Hotspot3Prize")
  avgWinnerEvents Event[]             @relation("AvgWinnerPrize")

  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdById String
}

model PrizeDistribution {
  id            String      @id @default(uuid())
  prizeSchema   PrizeSchema @relation(fields: [prizeSchemaId], references: [id], onDelete: Cascade)
  prizeSchemaId String
  fromPosition  Int
  toPosition    Int
  percentage    Float
}

model Event {
  id             String      @id @default(uuid())
  status         EventStatus @default(OPEN)
  name           String
  shortName      String
  date           DateTime
  type           EventType
  trainingCount  Int
  inventoryCount Int
  finalRaceCount Int
  hotspotCount   Int

  races Race[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creator   User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId String

  feeSchema   FeeSchema @relation(fields: [feeSchemaId], references: [id], onDelete: Restrict)
  feeSchemaId String

  finalRacePrizeSchema   PrizeSchema? @relation("FinalRacePrize", fields: [finalRacePrizeSchemaId], references: [id], onDelete: SetNull)
  finalRacePrizeSchemaId String?

  hotspot1PrizeSchema   PrizeSchema? @relation("Hotspot1Prize", fields: [hotspot1PrizeSchemaId], references: [id], onDelete: SetNull)
  hotspot1PrizeSchemaId String?

  hotspot2PrizeSchema   PrizeSchema? @relation("Hotspot2Prize", fields: [hotspot2PrizeSchemaId], references: [id], onDelete: SetNull)
  hotspot2PrizeSchemaId String?

  hotspot3PrizeSchema   PrizeSchema? @relation("Hotspot3Prize", fields: [hotspot3PrizeSchemaId], references: [id], onDelete: SetNull)
  hotspot3PrizeSchemaId String?

  avgWinnerPrizeSchema   PrizeSchema? @relation("AvgWinnerPrize", fields: [avgWinnerPrizeSchemaId], references: [id], onDelete: SetNull)
  avgWinnerPrizeSchemaId String?

  eventInventories   EventInventory[]
  EventInventoryItem EventInventoryItem[]
}

model EventInventory {
  id                  String               @id @default(uuid())
  event               Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId             String
  breeder             User                 @relation(fields: [breederId], references: [id], onDelete: Cascade)
  breederId           String
  registration_date   DateTime             @default(now())
  reserved_birds      Int
  loft                String
  note                String?
  isPaid              Boolean              @default(false)
  payments            Payment[]
  eventInventoryItems EventInventoryItem[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model EventInventoryItem {
  id            String    @id @default(uuid())
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId       String
  bird          Bird      @relation(fields: [birdId], references: [id], onDelete: Cascade)
  birdId        String
  rfId          String?   @unique // Unique per event, used for scans
  arrivalDate   DateTime?
  departureDate DateTime?

  band   String? @unique
  band_1 String?
  band_2 String?
  band_3 String?
  band_4 String?

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  raceItems        RaceItem[] // Direct relation for faster lookups
  EventInventory   EventInventory? @relation(fields: [eventInventoryId], references: [id], onDelete: Cascade)
  eventInventoryId String?

  @@index([rfId], map: "idx_rfId")
}

model Race {
  id                 String     @id @default(uuid())
  type               RACETYPE
  externalRaceId     String     @unique @map("RACE_ID")
  event              Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId            String
  location           String
  distance           Int
  startTime          DateTime
  arrivalDate        DateTime
  isClosed           Boolean    @default(false)
  sunrise            DateTime?
  sunset             DateTime?
  weather            String?
  wind               String?
  temperature        String?
  arrivalWeather     String?
  arrivalWind        String?
  arrivalTemperature String?
  baskets            Basket[]
  raceItems          RaceItem[]
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@index([eventId, startTime])
}

enum BirdSex {
  COCK
  HEN
}

model Bird {
  id           String    @id @default(uuid())
  birdName     String
  color        String
  is_active    Boolean   @default(true)
  is_lost      Boolean   @default(false)
  lost_date    DateTime?
  lost_race_id String?
  imageUrl     String?
  sex          BirdSex

  breeder   User   @relation(fields: [breederId], references: [id], onDelete: Cascade)
  breederId String

  eventInventoryItems EventInventoryItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Basket {
  id           String  @id @default(uuid())
  race         Race    @relation(fields: [raceId], references: [id], onDelete: Cascade)
  raceId       String
  basketNumber Int
  capacity     Int
  isRaceBasket Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  raceBasketItems RaceItem[] @relation("RaceBasketItems")
  loftBasketItems RaceItem[] @relation("LoftBasketItems")
}

model RaceItem {
  id                   String             @id @default(uuid())
  race                 Race               @relation(fields: [raceId], references: [id], onDelete: Cascade)
  raceId               String
  eventInventoryItem   EventInventoryItem @relation(fields: [eventInventoryItemId], references: [id], onDelete: Cascade)
  eventInventoryItemId String

  loftBasketed Boolean @default(false)
  loftBasket   Basket? @relation("LoftBasketItems", fields: [loftBasketId], references: [id], onDelete: SetNull)
  loftBasketId String?

  raceBasketed Boolean @default(false)
  raceBasket   Basket? @relation("RaceBasketItems", fields: [raceBasketId], references: [id], onDelete: SetNull)
  raceBasketId String?

  raceBasketTime DateTime?

  raceItemResult RaceItemResult?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RaceItemResult {
  id           String   @id @default(uuid())
  raceItem     RaceItem @relation(fields: [raceItemId], references: [id], onDelete: Cascade)
  raceItemId   String   @unique
  arrivalTime  DateTime
  distance     Float
  speed        Float
  distanceUnit String   @default("MILES")
  speedUnit    String   @default("MPH")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Payment {
  id               String         @id @default(uuid())
  paymentDate      DateTime?
  paymentValue     Float
  paymentMethod    String
  paymentNote      String?
  type             PaymentType
  transactionId    String?        @unique
  breeder          User           @relation(fields: [breederId], references: [id], onDelete: Cascade)
  breederId        String
  status           String         @default("PENDING")
  eventInventory   EventInventory @relation(fields: [eventInventoryId], references: [id], onDelete: Cascade)
  eventInventoryId String
}
